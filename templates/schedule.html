<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>Schedule</title>
</head>
<body>
    <div class="container">
        <h1 class="mt-4">Task List</h1>
        <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addTaskModal">+ Add Task</button>
        
        <ul class="list-group">
        {% if items %}
            </li>
            {% for item in items %}
                <li class="list-group-item" {% if item.status == 'completed' %}style="opacity: 0.5; background-color: #f0f0f0;"{% endif %}>
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>{{ item.class_name }} </strong></div>
                            <div>{{ item.description }}</div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>Status:</strong> {{ item.status }}
                                <button type="button" class="btn btn-sm btn-info viewNotesBtn" data-id="{{ item.id }}" data-status="{{ item.status }}">View Notes</button>
                                <button type="button" class="btn btn-sm btn-info changeStatusBtn" data-id="{{ item.id }}" data-status="{{ item.status }}">Change</button>
                                <button type="button" class="btn btn-sm btn-danger deleteBtn" data-id="{{ item.id }}">Delete</button></div>
                            <div><strong>Due Date:</strong> {{ item.end_datetime }}</div>
                        </div>
                    </div>
                </li>
            {% endfor %}
        {% else %}
            <li class="list-group-item">No tasks available.</li>
        {% endif %}
        </ul>
    </div>

    {% include 'add_task_modal.html' %}

    <!-- Status Change Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">Change Task Status</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <label for="statusInput">New Status:</label>
                    <input type="text" id="statusInput" class="form-control" placeholder="Enter new status">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="markCompletedBtn">Mark as Completed</button>
                    <button type="button" class="btn btn-primary" id="confirmStatusBtn">Change Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        let currentItemId = null;

        $(document).ready(function() {
            console.log('Document ready, looking for changeStatusBtn buttons');
            console.log('Found buttons:', $('.changeStatusBtn').length);
            
            $('.viewNotesBtn').click(function(e) {
                e.preventDefault();
                const itemId = $(this).data('id');
                window.location.href = '/view_notes/' + itemId;
            });

            $('.changeStatusBtn').click(function(e) {
                e.preventDefault();
                console.log('Change status button clicked');
                currentItemId = $(this).data('id');
                const currentStatus = $(this).data('status');
                console.log('Current item ID:', currentItemId);
                console.log('Current status:', currentStatus);
                $('#statusInput').val(currentStatus);
                $('#statusModal').modal('show');
                $('#statusInput').focus();
            });

            $('.deleteBtn').click(function(e) {
                e.preventDefault();
                const itemId = $(this).data('id');
                if (confirm('Are you sure you want to delete this task?')) {
                    window.location.href = '/delete/' + itemId;
                }
            });

            $('#markCompletedBtn').click(function() {
                console.log('Mark as completed clicked');
                $.post('/change_status', {
                    event_id: currentItemId,
                    new_status: 'completed'
                }, function(response) {
                    console.log('Success:', response);
                    $('#statusModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                }).fail(function(error) {
                    console.error('Error:', error);
                    alert('Error updating status: ' + error.statusText);
                });
            });

            $('#confirmStatusBtn').click(function() {
                const newStatus = $('#statusInput').val().trim();
                console.log('Confirm clicked, status:', newStatus);
                
                if (!newStatus) {
                    alert('Please enter a status');
                    return;
                }

                console.log('Sending POST to /change_status with event_id:', currentItemId, 'new_status:', newStatus);
                $.post('/change_status', {
                    event_id: currentItemId,
                    new_status: newStatus
                }, function(response) {
                    console.log('Success:', response);
                    $('#statusModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                }).fail(function(error) {
                    console.error('Error:', error);
                    alert('Error updating status: ' + error.statusText);
                });
            });

            $('#statusInput').keypress(function(e) {
                if (e.which === 13) {
                    $('#confirmStatusBtn').click();
                }
            });
        });
    </script>
</body>
</html>